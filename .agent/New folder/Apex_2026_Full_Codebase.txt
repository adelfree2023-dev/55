################################################################################
#  APEX PROJECT CODEBASE ARCHIVE
################################################################################
#
#  📊 STATISTICS SUMMARY:
#  ---------------------
#  📂 Total Files : 3
#  📝 Total Lines : 394
#  🔤 Total Words : 1,987
#  🧮 Total Chars : 18,147
#  🪙 Est. Tokens : 4,537 (Approx. for LLM Context)
#
################################################################################


/*******************************************************************************
 * FILE: Collect-Project.ps1
 * PATH: .\New folder\Collect-Project.ps1
 *******************************************************************************/
# =============================================================================
#  APEX PROJECT COLLECTOR - SECURE & OPTIMIZED EDITION 🛡️
#  Features: Split Map/Code, Deep Stats, Security Filters, Noise Reduction
# =============================================================================

# 1. إعداد المسارات
$CurrentScriptPath = $PSScriptRoot
# تنبيه: هذا السطر يفترض أن السكربت بداخل مجلد فرعي (مثل tools). 
# إذا كان السكربت في المجلد الرئيسي للمشروع، غير السطر التالي ليصبح: $ParentProjectDir = $CurrentScriptPath
$ParentProjectDir = Split-Path -Parent $CurrentScriptPath 

# أسماء الملفات الناتجة
$MapFileName = "Apex_2026_Structure_Map.txt"
$CodeFileName = "Apex_2026_Full_Codebase.txt"

$MapFilePath = Join-Path $CurrentScriptPath $MapFileName
$CodeFilePath = Join-Path $CurrentScriptPath $CodeFileName

# 2. إعداد الفلاتر (تحديثات لتقليل الحجم والحماية)

# أ- مجلدات لا قيمة لها للذكاء الاصطناعي
$ExcludedFolders = @(
    "node_modules", ".git", ".idea", ".vscode", 
    "dist", "build", "coverage", "update", "bin", "obj", 
    ".next", ".nest", "assets", "public" # تمت إضافة assets و public لتقليل الحشو
)

# ب- امتدادات مسموحة (تم حذف env منها)
$AllowedExtensions = "\.(ts|js|json|html|css|scss|md|txt|java|py|cs|cpp|h|sql|prisma|ps1|sh|yml|yaml|xml|razor)$"

# ج- [جديد] ملفات محظورة بالاسم (لتقليل الحجم والحماية)
$BlockedFileNames = @(
    "package-lock.json", "yarn.lock", "pnpm-lock.yaml", # ملفات ضخمة جداً وغير مفيدة للكود
    ".env", ".env.local", ".env.production",            # ملفات أمنية خطيرة
    "npm-debug.log", ".DS_Store"                        # ملفات نظام
)

# د- [جديد] أنماط حساسة (Regex) للحماية القصوى
$SensitivePatterns = @(
    "^\.env.*$",        # أي ملف يبدأ بـ .env
    ".*\.key$",         # مفاتيح خاصة
    ".*\.pem$",         # شهادات
    ".*secrets.*\.json$" # ملفات أسرار
)

# 3. دالة استخراج الوصف (كما هي)
function Get-FileDescription {
    param([string]$FilePath)
    try {
        $Lines = Get-Content -Path $FilePath -TotalCount 10 -ErrorAction SilentlyContinue
        foreach ($Line in $Lines) {
            $l = $Line.Trim()
            if ([string]::IsNullOrWhiteSpace($l)) { continue }
            if ($l -match "^(import|package|require|const|let|var|export|class|interface|type|async|function|return|namespace|using)") { 
                if ($l -notmatch "^@") { return "" }
            }
            if ($l.StartsWith("//") -or $l.StartsWith("/*") -or $l.StartsWith("*") -or $l.StartsWith("#")) {
                $clean = $l -replace "^/{2,}\s*", "" -replace "^\/\*+\s*", "" -replace "^\*\s*", "" -replace "\*\/$", "" -replace "^#\s*", ""
                if ($clean.Length -gt 4 -and $clean -notmatch "^eslint") { 
                    if ($clean.Length -gt 50) { $clean = $clean.Substring(0, 47) + "..." }
                    return " ➤ $clean" 
                }
            }
            if ($l -match "@Controller") { return " ➤ [API Endpoint]" }
            if ($l -match "@Injectable") { return " ➤ [Service Logic]" }
            if ($l -match "@Entity") { return " ➤ [Database Entity]" }
        }
    } catch {}
    return ""
}

# 4. تنظيف القديم
if (Test-Path $MapFilePath) { Remove-Item $MapFilePath -Force -ErrorAction SilentlyContinue }
if (Test-Path $CodeFilePath) { Remove-Item $CodeFilePath -Force -ErrorAction SilentlyContinue }

# 5. جمع الملفات (مع تطبيق الفلاتر الجديدة)
Write-Host "🔍 Scanning Directory: $ParentProjectDir" -ForegroundColor Cyan

$AllFiles = Get-ChildItem -Path $ParentProjectDir -Recurse -File | 
    Where-Object { 
        $File = $_
        $RelPath = $File.FullName.Substring($ParentProjectDir.Length)
        
        # 1. فلتر المجلدات
        $IsExcludedFolder = ($ExcludedFolders | Where-Object { $RelPath -match [regex]::Escape($_) })
        if ($IsExcludedFolder) { return $false }

        # 2. فلتر الامتداد
        if ($File.Extension -notmatch $AllowedExtensions) { return $false }

        # 3. [حماية] فلتر الأسماء المحظورة (Lockfiles + .env)
        if ($BlockedFileNames -contains $File.Name) { return $false }

        # 4. [حماية] فلتر الأنماط الحساسة
        foreach ($Pattern in $SensitivePatterns) {
            if ($File.Name -match $Pattern) { 
                Write-Warning "🚫 Security Block: Skipped sensitive file [$($File.Name)]"
                return $false 
            }
        }

        return $true
    }

# =============================================================================
# مرحلة 1: الحساب المسبق للإحصائيات
# =============================================================================
Write-Host "🧮 Calculating Deep Stats (Chars, Words, Tokens)..." -ForegroundColor Yellow

$Stats = @{
    Files = $AllFiles.Count
    Lines = 0
    Words = 0
    Chars = 0
    Tokens = 0
}

foreach ($File in $AllFiles) {
    try {
        $Text = [System.IO.File]::ReadAllText($File.FullName)
        $Stats.Chars += $Text.Length
        $FileLines = $Text.Split("`n").Count
        $Stats.Lines += $FileLines
        $FileWords = $Text.Split([char[]]@(' ', "`t", "`n", "`r"), [StringSplitOptions]::RemoveEmptyEntries).Count
        $Stats.Words += $FileWords
    } catch { 
        Write-Warning "Could not read stats for $($File.Name)" 
    }
}

$Stats.Tokens = [Math]::Round($Stats.Chars / 4)
$FmtLines  = "{0:N0}" -f $Stats.Lines
$FmtWords  = "{0:N0}" -f $Stats.Words
$FmtChars  = "{0:N0}" -f $Stats.Chars
$FmtTokens = "{0:N0}" -f $Stats.Tokens

# =============================================================================
# مرحلة 2: إنشاء ملف خريطة المشروع
# =============================================================================
Write-Host "🗺️  Generating Structure Map..." -ForegroundColor Green

$MapStream = [System.IO.StreamWriter]::new($MapFilePath, $false, [System.Text.Encoding]::UTF8)

try {
    $MapStream.WriteLine("========================================================")
    $MapStream.WriteLine("🗺️  PROJECT STRUCTURE MAP")
    $MapStream.WriteLine("========================================================")
    $MapStream.WriteLine("📅 Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm')")
    $MapStream.WriteLine("📂 Files Included: $($Stats.Files)")
    $MapStream.WriteLine("🚫 Noise Filtered: Lockfiles, Logs, Assets")
    $MapStream.WriteLine("🔒 Security Filter: ACTIVE")
    $MapStream.WriteLine("========================================================`n")

    function Write-DirTree {
        param([string]$Path, [string]$Indent)
        # تطبيق نفس الفلاتر هنا للعرض في الخريطة
        $Items = Get-ChildItem -Path $Path | Where-Object {
            $n = $_.Name
            $n -notin $ExcludedFolders -and 
            $n -notin $BlockedFileNames -and
            ($_.PSIsContainer -or ($_.Extension -match $AllowedExtensions -and $n -notmatch "^\.env"))
        }
        $Count = $Items.Count; $i = 0
        foreach ($Item in $Items) {
            $i++; $IsLast = ($i -eq $Count)
            $Prefix = if ($IsLast) { "└── " } else { "├── " }
            $ChildIndent = if ($IsLast) { "    " } else { "│   " }
            
            if ($Item.PSIsContainer) {
                $MapStream.WriteLine("$Indent$Prefix📂 $($Item.Name)")
                Write-DirTree -Path $Item.FullName -Indent "$Indent$ChildIndent"
            } else {
                $Desc = Get-FileDescription -FilePath $Item.FullName
                $MapStream.WriteLine("$Indent$Prefix📄 $($Item.Name)$Desc")
            }
        }
    }
    Write-DirTree -Path $ParentProjectDir -Indent ""
}
finally { $MapStream.Close(); $MapStream.Dispose() }

# =============================================================================
# مرحلة 3: إنشاء ملف الأكواد الكامل
# =============================================================================
Write-Host "📦 Archiving Code Content..." -ForegroundColor Green

$CodeStream = [System.IO.StreamWriter]::new($CodeFilePath, $false, [System.Text.Encoding]::UTF8)

try {
    $CodeStream.WriteLine("################################################################################")
    $CodeStream.WriteLine("#  APEX PROJECT CODEBASE ARCHIVE")
    $CodeStream.WriteLine("################################################################################")
    $CodeStream.WriteLine("#")
    $CodeStream.WriteLine("#  📊 STATISTICS SUMMARY:")
    $CodeStream.WriteLine("#  ---------------------")
    $CodeStream.WriteLine("#  📂 Total Files : $($Stats.Files)")
    $CodeStream.WriteLine("#  📝 Total Lines : $FmtLines")
    $CodeStream.WriteLine("#  🔤 Total Words : $FmtWords")
    $CodeStream.WriteLine("#  🧮 Total Chars : $FmtChars")
    $CodeStream.WriteLine("#  🪙 Est. Tokens : $FmtTokens (Approx. for LLM Context)")
    $CodeStream.WriteLine("#")
    $CodeStream.WriteLine("################################################################################`n")

    $Counter = 0
    foreach ($File in $AllFiles) {
        $Counter++
        $Percent = [math]::Round(($Counter / $Stats.Files) * 100)
        Write-Progress -Activity "Writing Code File..." -Status "$($File.Name)" -PercentComplete $Percent

        # إخفاء المسار الكامل في الملف الناتج لحماية الخصوصية
        $SafePath = $File.FullName.Replace($ParentProjectDir, "")

        $CodeStream.WriteLine("`n/*******************************************************************************")
        $CodeStream.WriteLine(" * FILE: $($File.Name)")
        $CodeStream.WriteLine(" * PATH: .$SafePath")
        $CodeStream.WriteLine(" *******************************************************************************/")
        
        try {
            $Content = [System.IO.File]::ReadAllText($File.FullName)
            $CodeStream.WriteLine($Content)
        } catch { 
            $CodeStream.WriteLine("[ERROR READING FILE CONTENT]") 
        }
    }
}
finally { $CodeStream.Close(); $CodeStream.Dispose() }

Write-Host "`n✅ SUCCESS!" -ForegroundColor Green
Write-Host "   1️⃣  Map File  : $MapFileName"
Write-Host "   2️⃣  Code File : $CodeFileName (Tokens: $FmtTokens)"

/*******************************************************************************
 * FILE: SKILL.md
 * PATH: .\skills\apex_protocol_enforcer\SKILL.md
 *******************************************************************************/
---
name: apex_protocol_enforcer
description: Ensures code compliance with Apex v2 S1-S8 security protocols and Engineering Constitution.
---

# 🛡️ Apex Protocol Enforcer

This skill is responsible for auditing and enforcing the **S1-S8 Security Protocols** and the **Engineering Constitution** of Apex v2.

## 🏁 Handover Verification (Phase 1)
When delivering Phase 1 to a Tech Lead, ensure:
1. `bun run scripts/test-s1.ts` returns success.
2. The provisioning script execution time is logged and is `< 55s`.
3. The server `docker ps` reflects all 4 core containers.

## 📋 Security Protocols (S1-S8)

### 🏗️ S0: The Zero-Tolerance Testing Rule (Mandatory)
> [!IMPORTANT]
> **Strict Constitutional Rule**: It is strictly forbidden to create any new implementation file (.ts, .js, .tsx) without an accompanying `.spec.ts` (unit/security test) file. 
> - Every new logic file MUST have a test coverage of **at least 90%**.
> - **Mandatory Verification**: You MUST ensure all tests are passing and coverage threshold is met before completing any task.
> - Failure to provide a test file or meet the 90% coverage threshold is a **Protocol Violation**.

### S1: Environment Verification
- **Requirement**: Use Zod with `@nestjs/config`.
- **Enforcement**: Check `packages/config` or main app entry points for Zod validation logic. The app must crash if env vars are missing.

### S2: Tenant Isolation
- **Requirement**: Schema-based isolation using Drizzle.
- **Enforcement**: 
    - Verify middleware extracts `X-Tenant-ID`.
    - Ensure `SET search_path = tenant_{id}` is called before queries.
    - Check for `TenantScopedGuard` on controllers.

### S3: Input Validation
- **Requirement**: Global `ZodValidationPipe` + Zod schemas for all DTOs.
- **Enforcement**: Verify that every controller method uses a Zod-backed DTO. Manual DTOs are forbidden.

### S4: Audit Logging
- **Requirement**: NestJS Interceptor + `AsyncLocalStorage`.
- **Enforcement**: Ensure all write operations (POST/PUT/DELETE) are intercepted and logged to the `audit_logs` table.

### S5: Exception Handling
- **Requirement**: Global Exception Filter + GlitchTip reporting.
- **Enforcement**: Standardized error responses (no stack traces). 500 errors must be sent to GlitchTip.

### S6: Rate Limiting
- **Requirement**: Redis + `@nestjs/throttler`.
- **Enforcement**: Check for throttler guards and Redis connection. Dynamic limits per tenant tier must be applied.

### S7: Encryption
- **Requirement**: AES-256-GCM for PII/API keys. TLS forced.
- **Enforcement**: Verify sensitive data is encrypted at rest in the database.

### S8: Web Security
- **Requirement**: Helmet + Strict CSP + CORS.
- **Enforcement**: Verify Helmet configuration and dynamic CORS per tenant domain.

## 📜 Engineering Constitution Audit

- **Monorepo Strategy**: `apps/*` must never import from another `apps/*`. Cross-app communication via `packages/events`.
- **Lego Philosophy**: Strict folder structure for NestJS modules: `domain/`, `application/`, `infrastructure/`, `interfaces/`.
- **Naming Conventions**: `kebab-case.ts` for files, `PascalCase` for classes, `snake_case` for DB tables.
- **Zod as Truth**: All types/interfaces must derive from Zod schemas using `z.infer`.

## 🛠️ Audit Commands
- `audit:security`: Runs a scan across the codebase to check for S1-S8 compliance.
- `audit:constitution`: Checks folder structures and imports.

## 🛑 Deployment & Environment Guardrails

- **Windows Environment**: Strictly for development, editing, and file preparation. **NO** execution of production-critical processes or downloads unless essential for file prep.
- **Server Environment**: The **only** source of truth for runtime, testing, and final verification.
- **Git Protocol**: Direct pushes to server are discouraged; workflow must be `Local -> GitHub -> Server`.
- Using `// biome-ignore` without justification.
- Manual DTOs or TypeScript interfaces for API contracts (must use Zod).
- Direct cross-module database access.
- Hardcoded secrets or missing S1 validation.


/*******************************************************************************
 * FILE: SKILL.md
 * PATH: .\skills\apex_provisioning_master\SKILL.md
 *******************************************************************************/
---
name: apex_provisioning_master
description: Manages the complex provisioning flow and tenant lifecycle for Apex v2.
---

# ⚡ Apex Provisioning Master (v2.0)

This skill is the guardian of the **"1-Minute Provisioning" Engine**. It ensures tenants are onboarded, isolated, and managed with surgical precision.

## 🚀 Provisioning Flow Management

The core sequence implements a **4-Phase Architecture** to ensure compliance with S2 and S4 protocols:

1.  **Phase 1: Schema Creation (S2 Isolation)**
    *   **Service**: `SchemaCreatorService`
    *   **Action**: Creates `tenant_{subdomain}` schema in PostgreSQL.
    *   **Security**: Sets default privileges and verifies `search_path` isolation.

2.  **Phase 2: Data Seeding (Blueprint System)**
    *   **Service**: `DataSeederService`
    *   **Action**: Seeds products, pages, and settings based on `blueprintId` (standard/e-commerce).
    *   **Tech**: Uses `drizzle-orm` for high-performance batch inserts.

3.  **Phase 3: Traefik Routing (Dynamic Ingress)**
    *   **Service**: `TraefikRouterService`
    *   **Action**: Generates dynamic YAML configuration in `infra/docker/traefik/dynamic`.
    *   **Result**: Live route at `{subdomain}.apex.localhost`.

4.  **Phase 4: Registration & Audit (S4 Compliance)**
    *   **Action**: Registers tenant in public table and logs `TENANT_PROVISIONED` event in `audit_logs`.
    *   **Validation**: Ensures north-star metric (< 55s) is met.

## 🛡️ Tenant Lifecycle & Governance

-   **Kill Switch**: Logic to update `tenants.status` and ensure Middleware/Traefik blocks access (Rule 3.2).
-   **Resource Quotas**: Monitor and enforce limits on products, storage, and users per plan.
-   **Feature Gating**: Enable/Disable modules based on the tenant's current plan.
-   **Backups**: Trigger `pg_dump` snapshots for specific tenant schemas.

## 📊 Monitoring & Alerts

-   **Audit Logs**: Every provisioning step must be logged (S4).
-   **Time Audit**: Monitor the time taken for each stage of provisioning.
-   **Failures**: Redirect failed provisioning attempts to a "Manual Review" queue and alert developers.

## 🌐 Infrastructure & Deployment

-   **GitHub Repository**: `https://github.com/adelfree2023-dev/55`
-   **Production Server IP**: `34.102.116.215`
-   **SSH Access**: `ssh -i ~/.ssh/id_ed25519_apex apex-v2-dev@34.102.116.215`

### 🗄️ Database & Services (Production Context)

| Service | Host | Port | Credentials |
| :--- | :--- | :--- | :--- |
| **PostgreSQL** | `localhost` | `5432` | User: `apex` \| Pass: `apex` \| DB: `apex` |
| **Redis** | `localhost` | `6379` | No Password (Internal Network) |
| **MinIO API** | `localhost` | `9000` | Access Key: `apex` \| Secret Key: `apex-secret` |
| **Traefik** | `localhost` | `80` | Dynamic Config Dir: `~/apex-v2/infra/docker/traefik/dynamic` |

## 🛠️ Provisioning & Deployment Commands

-   `deploy:sync`: Pushes local changes to GitHub and pulls on the server.
-   `provision:tenant [subdomain]`: Executes the full onboarding flow via CLI.
-   `infra:logs`: `ssh [server] "cd ~/apex-v2/infra && docker-compose logs -f"`

## 🤝 Phase 1 Handover Status

-   **Date**: 2026-01-30
-   **Version**: 2.1.0-PROVISIONING-STABLE
-   **Verification Audit**:
    -   Arch-S1 (Env): **Green**
    -   Arch-S2 (Isolation): **Green**
    -   S3 (Validation): **Green**
    -   S4 (Audit): **Green**
-   **Test Coverage**: > 95% Core Logic
-   **Waiting for**: Phase 2 (Tenant MVP).

## ⚖️ Rules of Management

-   **Idempotency**: All management operations must be idempotent (Rule 3.2).
-   **Isolation First**: No operation should ever affect more than one tenant unless it's a platform-wide maintenance.
-   **Audit Everything**: No manual database edits. Use the Super Admin API or these audited scripts.

